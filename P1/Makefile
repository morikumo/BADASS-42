# ---------------------------------------------------------------------------------------------------
# Installation de GNS3 et de Docker sur Debian
# ---------------------------------------------------------------------------------------------------

# Cible principale : installe Docker, GNS3 et l'image Docker de FRRouting
all: gns3 docker-image
	@echo "[‚úì] Installation compl√®te termin√©e."
	@echo "üëâ Red√©marre ta session pour que les changements prennent effet (acc√®s Docker)."

# ---------------------------------------------------------------------------------------------------
# Installation de Docker
# ---------------------------------------------------------------------------------------------------

install-docker:
	@echo "[+] Installation de la configuration de base"
	sudo apt update
	sudo apt install -y docker.io
	sudo systemctl enable docker
	sudo usermod -aG docker $(USER)  # Ajout de l'utilisateur au groupe docker
	@echo "[‚úì] Base install√©e. Red√©marre ta session pour que le groupe Docker soit pris en compte."

# ---------------------------------------------------------------------------------------------------
# Installation de GNS3 (d√©pend de l'installation de Docker)
# ---------------------------------------------------------------------------------------------------

gns3: install-docker gns3-gui docker-image
	@python3 --version
	@pip3 --version
	@echo "[‚úì] GNS3 GUI install√©."

# ---------------------------------------------------------------------------------------------------
# T√©l√©chargement de l'image Docker FRRouting
# ---------------------------------------------------------------------------------------------------

docker-image:
	@echo "üåê T√©l√©chargement de l'image FRRouting officielle..."
	@if ! docker info > /dev/null 2>&1; then \
		echo "‚ö†Ô∏è  L'utilisateur $(USER) n'a pas encore acc√®s √† Docker."; \
		echo "üëâ Red√©marre ta session puis relance : make docker-image"; \
		exit 1; \
	fi
	docker pull frrouting/frr:latest
	@echo "[‚úì] Image Docker t√©l√©charg√©e."

# ---------------------------------------------------------------------------------------------------
# Installation du GNS3 GUI et de ses d√©pendances (D√©bian)
# ---------------------------------------------------------------------------------------------------

gns3-gui:
	@echo "üîß Installation des d√©pendances pour GNS3..."
	sudo add-apt-repository ppa:gns3/ppa
	sudo apt update                                
	sudo apt install gns3-gui gns3-server
	sudo apt remove docker docker-engine docker.io
	sudo snap remove docker
	sudo apt-get install apt-transport-https ca-certificates curl software-properties-common
	@echo "[‚úì] D√©pendances install√©es."
	curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
	sudo apt update
	sudo apt install docker-ce
	sudo usermod -aG ubridge,libvirt,kvm,wireshark,docker $(whoami)
	@echo "[‚úì] GNS3 GUI install√©."


# ---------------------------------------------------------------------------------------------------
# Build les images docker
# ---------------------------------------------------------------------------------------------------
build-images:
	@echo "üî® Construction des images Docker..."
	docker build -f router_mabid -t router-mabid-p1 .
	docker build -f host_mabid -t host-mabid-p1 .
	@echo "[‚úì] Images Docker construites."


# ---------------------------------------------------------------------------------------------------
# Notes :
# - N'oublie pas de red√©marrer ta session pour que Docker et GNS3 fonctionnent correctement.
# - Les √©tapes d'installation peuvent √™tre modifi√©es en fonction de tes besoins sp√©cifiques.
# ---------------------------------------------------------------------------------------------------
# ---------------------------------------------------------------------------------------------------
# Nettoyage des fichiers temporaires (par exemple, fichiers .deb)
# ---------------------------------------------------------------------------------------------------

clean:
	@echo "üßπ Nettoyage de l'espace de travail..."
	rm -f *.deb *venv
	docker rmi -f $(docker images)
	docker volume prune --force
	docker network prune --force
	docker image prune --all --force
	docker rm -f $(docker ps -aq)
	@echo "[‚úì] Docker et fichiers nettoy√©s."

