# ---------------------------------------------------------------------------------------------------
# Installation de GNS3 et de Docker sur Debian
# ---------------------------------------------------------------------------------------------------

# Cible principale : installe Docker, GNS3 et l'image Docker de FRRouting
all: gns3 docker-image
	@echo "[‚úì] Installation compl√®te termin√©e."
	@echo "üëâ Red√©marre ta session pour que les changements prennent effet (acc√®s Docker)."

# ---------------------------------------------------------------------------------------------------
# Installation de Docker
# ---------------------------------------------------------------------------------------------------

install-docker:
	@echo "[+] Installation de la configuration de base"
	sudo apt update
	sudo apt install -y docker.io
	sudo systemctl enable docker
	sudo usermod -aG docker $(USER)  # Ajout de l'utilisateur au groupe docker
	@echo "[‚úì] Base install√©e. Red√©marre ta session pour que le groupe Docker soit pris en compte."

# ---------------------------------------------------------------------------------------------------
# Installation de GNS3 (d√©pend de l'installation de Docker)
# ---------------------------------------------------------------------------------------------------

gns3: install-docker gns3-gui docker-image
	@python3 --version
	@pip3 --version
	@echo "[‚úì] GNS3 GUI install√©."

# ---------------------------------------------------------------------------------------------------
# T√©l√©chargement de l'image Docker FRRouting
# ---------------------------------------------------------------------------------------------------

docker-image:
	@echo "üåê T√©l√©chargement de l'image FRRouting officielle..."
	@if ! docker info > /dev/null 2>&1; then \
		echo "‚ö†Ô∏è  L'utilisateur $(USER) n'a pas encore acc√®s √† Docker."; \
		echo "üëâ Red√©marre ta session puis relance : make docker-image"; \
		exit 1; \
	fi
	docker pull frrouting/frr:latest
	@echo "[‚úì] Image Docker t√©l√©charg√©e."

# ---------------------------------------------------------------------------------------------------
# Installation du GNS3 GUI et de ses d√©pendances
# ---------------------------------------------------------------------------------------------------

gns3-gui:
	@echo "üîß Installation des d√©pendances pour GNS3..."
	sudo apt update
	sudo apt install -y python3 python3-pip pipx python3-pyqt5 python3-pyqt5.qtwebsockets python3-pyqt5.qtsvg \
		qemu-system-x86 qemu-utils libvirt-clients libvirt-daemon-system virtinst software-properties-common \
		ca-certificates curl gnupg2
	@echo "[‚úì] D√©pendances install√©es."

	@echo "üì• T√©l√©chargement et installation de Dynamips..."
	wget http://ftp.us.debian.org/debian/pool/non-free/d/dynamips/dynamips_0.2.14-1_amd64.deb
	sudo dpkg -i dynamips_0.2.14-1_amd64.deb
	@echo "[‚úì] Dynamips install√©."

	@echo "‚öôÔ∏è Installation de GNS3 Server et GNS3 GUI via pipx..."
	pipx install gns3-server
	pipx install gns3-gui
	pipx ensurepath  # S'assure que pipx est correctement configur√© dans le PATH
	pipx inject gns3-gui gns3-server PyQt5
	@echo "[‚úì] GNS3 GUI install√©."

# ---------------------------------------------------------------------------------------------------
# Notes :
# - N'oublie pas de red√©marrer ta session pour que Docker et GNS3 fonctionnent correctement.
# - Les √©tapes d'installation peuvent √™tre modifi√©es en fonction de tes besoins sp√©cifiques.
# ---------------------------------------------------------------------------------------------------
# ---------------------------------------------------------------------------------------------------
# Nettoyage des fichiers temporaires (par exemple, fichiers .deb)
# ---------------------------------------------------------------------------------------------------

clean:
	@echo "üßπ Nettoyage de l'espace de travail..."
	rm -f dynamips_0.2.14-1_amd64.deb*
	@echo "[‚úì] Fichiers nettoy√©s."
